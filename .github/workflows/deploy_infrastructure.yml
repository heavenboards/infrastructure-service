name: 🔥 Деплой инфраструктуры приложения

on:
  push:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 👉🏼 Переключаемся на файлы проекта
        uses: actions/checkout@v3

      - name: 👉🏼 Устанавливаем sshpass
        run: sudo apt update && sudo apt install -y sshpass

      - name: 👉🏼 Подключаемся к удаленному серверу
        run: sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "echo Connected to the remote server ${{ vars.REMOTE_SERVER_HOST }}! && rm -f /root/heavenboards/infrastructure/docker-compose.yml || true"

      - name: 👉🏼 Копируем файл docker-compose.yml на удаленный сервер
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} scp docker-compose.yml root@${{ vars.REMOTE_SERVER_HOST }}:/root/heavenboards/infrastructure

      - name: 👉🏼 Переподнимаем network и все контейнеры
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "
            rm -rf /root/heavenboards/ || true &&
            mkdir /root/heavenboards &&
            mkdir /root/heavenboards/infrastructure &&
            cd /root/heavenboards/infrastructure &&
            docker compose stop || true &&
            docker compose rm || true &&
            docker network create -d bridge ${{ vars.DOCKER_NETWORK_NAME }} || true &&
            touch .env
            echo DOCKER_NETWORK_NAME=${{ vars.DOCKER_NETWORK_NAME }} > .env
            echo POSTGRES_DATABASE_USERNAME=${{ vars.POSTGRES_DATABASE_USERNAME }} >> .env
            echoPOSTGRES_DATABASE_PASSWORD=${{ vars.POSTGRES_DATABASE_PASSWORD }} >> .env
            docker compose up -d --remove-orphans"
