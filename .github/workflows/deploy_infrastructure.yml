name: üî• –î–µ–ø–ª–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

on:
  push:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üëâüèº –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
        uses: actions/checkout@v3

      - name: üëâüèº –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sshpass
        run: sudo apt update && sudo apt install -y sshpass

      - name: üëâüèº –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
        run: sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "echo Connected to the remote server ${{ vars.REMOTE_SERVER_HOST }}! && rm -f /root/heavenboards/infrastructure/docker-compose.yml || true"

      - name: üëâüèº –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª docker-compose.yml –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} scp docker-compose.yml root@${{ vars.REMOTE_SERVER_HOST }}:/root/heavenboards/infrastructure

      - name: üëâüèº –ü–µ—Ä–µ–ø–æ–¥–Ω–∏–º–∞–µ–º network –∏ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "cd /root/heavenboards/infrastructure && docker compose stop || true && docker compose rm || true && docker network create -d bridge ${{ vars.DOCKER_NETWORK_NAME }} || true && docker compose up -d --remove-orphans --env DOCKER_NETWORK_NAME=${{ vars.DOCKER_NETWORK_NAME }} POSTGRES_DATABASE_USERNAME=${{ vars.POSTGRES_DATABASE_USERNAME }} POSTGRES_DATABASE_PASSWORD=${{ vars.POSTGRES_DATABASE_PASSWORD }}"
