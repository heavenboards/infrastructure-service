name: ðŸ”¥ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ

on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ‘‰ðŸ¼ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        uses: actions/checkout@v3

      - name: ðŸ‘‰ðŸ¼ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ sshpass
        run: sudo apt update && sudo apt install -y sshpass

      - name: ðŸ‘‰ðŸ¼ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ñƒ
        run: sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "
          echo Connected to the remote server ${{ vars.REMOTE_SERVER_HOST }}! &&
          rm -rf /root/heavenboards/ || true &&
          mkdir /root/heavenboards &&
          mkdir /root/heavenboards/infrastructure"

      - name: ðŸ‘‰ðŸ¼ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð» docker-compose.yml Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} scp docker-compose.yml root@${{ vars.REMOTE_SERVER_HOST }}:/root/heavenboards/infrastructure

      - name: ðŸ‘‰ðŸ¼ ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ network Ð¸ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        run: |
          sshpass -p ${{ vars.REMOTE_SERVER_PASSWORD }} ssh -o StrictHostKeyChecking=no root@${{ vars.REMOTE_SERVER_HOST }} "
            cd /root/heavenboards/infrastructure &&
            docker compose stop || true &&
            docker compose rm || true &&
            docker network rm heavenboards_network || true &&
            docker network create -d bridge heavenboards_network || true &&
            touch .env &&
            echo POSTGRES_DATABASE_USERNAME=${{ vars.POSTGRES_DATABASE_USERNAME }} > .env &&
            echo POSTGRES_DATABASE_PASSWORD=${{ vars.POSTGRES_DATABASE_PASSWORD }} >> .env &&
            ls -la &&
            cat .env &&
            docker compose up -d --remove-orphans"
